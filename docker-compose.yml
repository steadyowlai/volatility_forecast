version: '3.8'

services:
  #base Image; contains common dependencies for all services
  base:
    build:
      context: .
      dockerfile: Dockerfile.base
    image: vf-base

  # Ingest Service: downloads market data from Yahoo Finance
  # Run this first to get raw data into data/curated.market/
  ingest:
    build:
      context: .
      dockerfile: services/ingest/Dockerfile
    image: vf-ingest
    container_name: vf-ingest
    depends_on:
      - base
    env_file:
      - .env
    volumes:
      - ./data:/app/data
    command: ["python", "services/ingest/app.py"]

  # Features Service: computes 21 Level 1 features from curated data
  # Reads from data/curated.market/, writes to data/features.L1/
  # Run this after ingest to generate features
  features:
    build:
      context: .
      dockerfile: services/features/Dockerfile
    image: vf-features
    container_name: vf-features
    depends_on:
      - base
      - ingest
    volumes:
      - ./data:/app/data
    command: ["python", "services/features/app.py"]

  # Test Service: runs pytest with coverage
  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    image: vf-test
    container_name: vf-test
    depends_on:
      - base
    volumes:
      - ./tests:/app/tests
      - ./services:/app/services
      - ./libs:/app/libs
      - ./data:/app/data
    command: ["pytest", "tests/", "-v", "--cov=services", "--cov=libs", "--cov-report=term-missing"]

  # Future services will be added here:
  
  # train:
  #   build:
  #     context: .
  #     dockerfile: services/train/Dockerfile
  #   image: vf-train
  #   depends_on:
  #     - base
  #     - features
  #   env_file:
  #     - .env
  #   volumes:
  #     - ./data:/app/data
  #     - ./artifacts:/app/artifacts
  
  # infer:
  #   build:
  #     context: .
  #     dockerfile: services/infer/Dockerfile
  #   image: vf-infer
  #   depends_on:
  #     - base
  #     - train
  #   env_file:
  #     - .env
  #   volumes:
  #     - ./data:/app/data
  #     - ./artifacts:/app/artifacts
  
  # api:
  #   build:
  #     context: .
  #     dockerfile: services/api/Dockerfile
  #   image: vf-api
  #   ports:
  #     - "8000:8000"
  #   depends_on:
  #     - base
  #     - infer
  #   env_file:
  #     - .env
  #   volumes:
  #     - ./data:/app/data
  #     - ./artifacts:/app/artifacts
  
  # dashboard:
  #   build:
  #     context: .
  #     dockerfile: services/dashboard/Dockerfile
  #   image: vf-dashboard
  #   ports:
  #     - "8501:8501"
  #   depends_on:
  #     - base
  #     - infer
  #   env_file:
  #     - .env
  #   volumes:
  #     - ./data:/app/data

networks:
  default:
    name: vf-network
