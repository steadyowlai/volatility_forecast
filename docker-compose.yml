version: '3.8'

services:
  #base Image; contains common dependencies for all services
  base:
    build:
      context: .
      dockerfile: Dockerfile.base
    image: vf-base

  # Ingest Service: downloads market data from Yahoo Finance
  # Run this first to get raw data into data/curated.market/
  ingest:
    build:
      context: .
      dockerfile: services/ingest/Dockerfile
    image: vf-ingest
    container_name: vf-ingest
    depends_on:
      - base
    env_file:
      - .env
    volumes:
      - ./data:/app/data
    command: ["python", "services/ingest/app.py"]

  # Features Service: computes 21 Level 1 features from curated data
  # Reads from data/curated.market/, writes to data/features.L1/
  # Run this after ingest to generate features
  features:
    build:
      context: .
      dockerfile: services/features/Dockerfile
    image: vf-features
    container_name: vf-features
    depends_on:
      - base
      - ingest
    volumes:
      - ./data:/app/data
    command: ["python", "services/features/app.py"]

  # Test Service: runs pytest with coverage
  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    image: vf-test
    container_name: vf-test
    depends_on:
      - base
    volumes:
      - ./tests:/app/tests
      - ./services:/app/services
      - ./libs:/app/libs
      - ./data:/app/data
    command: ["pytest", "tests/", "-v", "--cov=services", "--cov=libs", "--cov-report=term-missing"]

  # Dataset Preparation Service: creates and maintains master dataset
  # Runs daily after features to create data/master_dataset.parquet
  # This ensures consistency between training and monitoring
  prepare_dataset:
    build:
      context: .
      dockerfile: services/prepare_dataset/Dockerfile
    image: vf-prepare-dataset
    container_name: vf-prepare-dataset
    depends_on:
      - base
      - features
    volumes:
      - ./data:/app/data
    command: ["python", "app.py"]

  # Training Service: trains model with best hyperparameters from tuning
  # Reads from data/master_dataset.parquet, saves model to models/ directory
  train:
    build:
      context: .
      dockerfile: services/train/Dockerfile
    image: vf-train
    container_name: vf-train
    depends_on:
      - base
      - prepare_dataset
    volumes:
      - ./data:/app/data
      - ./config:/app/config
      - ./final_model:/app/final_model
      - ./models:/app/models
      - ./libs:/app/libs
    command: ["python", "services/train/app.py"]

  # Prediction Service: generates daily volatility forecasts
  # Loads model from models/ directory, reads latest features, predicts next-day volatility
  predict:
    build:
      context: .
      dockerfile: services/predict/Dockerfile
    image: vf-predict
    container_name: vf-predict
    depends_on:
      - base
      - features
      - train
    volumes:
      - ./data:/app/data
      - ./models:/app/models
    command: ["python", "app.py"]

  # Monitoring Service: tracks production performance and detects drift
  # Compares past predictions (5+ days old) with actual outcomes
  # Different from training validation - this monitors live production performance
  monitor:
    build:
      context: .
      dockerfile: services/monitor/Dockerfile
    image: vf-monitor
    container_name: vf-monitor
    depends_on:
      - base
      - predict
    volumes:
      - ./data:/app/data
      - ./models:/app/models
    command: ["python", "app.py"]

  # Future services will be added here:
  
  # infer:
  #   build:
  #     context: .
  #     dockerfile: services/infer/Dockerfile
  #   image: vf-infer
  #   depends_on:
  #     - base
  #     - train
  #   env_file:
  #     - .env
  #   volumes:
  #     - ./data:/app/data
  #     - ./artifacts:/app/artifacts
  
  # api:
  #   build:
  #     context: .
  #     dockerfile: services/api/Dockerfile
  #   image: vf-api
  #   ports:
  #     - "8000:8000"
  #   depends_on:
  #     - base
  #     - infer
  #   env_file:
  #     - .env
  #   volumes:
  #     - ./data:/app/data
  #     - ./artifacts:/app/artifacts
  
  # dashboard:
  #   build:
  #     context: .
  #     dockerfile: services/dashboard/Dockerfile
  #   image: vf-dashboard
  #   ports:
  #     - "8501:8501"
  #   depends_on:
  #     - base
  #     - infer
  #   env_file:
  #     - .env
  #   volumes:
  #     - ./data:/app/data

networks:
  default:
    name: vf-network
